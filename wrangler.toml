name = "saavy-uptime"
main = "apps/backend/build/index.js"
compatibility_date = "2025-11-11"
workers_dev = false

[vars]
ACCESS_TEAM_DOMAIN = "https://saavylab.cloudflareaccess.com"
ACCESS_AUD = "e8604f5d9df109c391b937c4293c06fa76548def743a48fec18da93e0ddddeda"
DISPATCH_TOKEN = "local-dev-token"
DISPATCH_BASE_URL = "http://127.0.0.1:8787/api"
ENABLE_TICKER_ADMIN = 1

[build]
command = "cargo install worker-build && worker-build --release"

[[durable_objects.bindings]]
name = "TICKER"
class_name = "Ticker"
script_name = "saavy-uptime"

[[migrations]]
tag = "v1"
new_classes = ["Ticker"]

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[[d1_databases]]
binding = "DB"
database_name = "saavy_uptime_dev"
database_id = "00000000-0000-0000-0000-000000000000"
migrations_dir = "db/migrations"
migrations_table = "d1_migrations"

[[analytics_engine_datasets]]
binding = "AE"
dataset = "saavy_uptime_dev"

[[r2_buckets]]
binding = "ARCHIVE_BUCKET"
bucket_name = "saavy-uptime-dev"

[[queues.producers]]
queue = "heartbeat_summaries"
binding = "HEARTBEAT_SUMMARIES"

[[queues.consumers]]
queue = "heartbeat_summaries"
max_batch_size = 100
max_batch_timeout = 5

[[queues.producers]]
queue = "traces"
binding = "TRACE_QUEUE"

[[queues.consumers]]
queue = "traces"
max_batch_size = 100
max_batch_timeout = 5

# ========================================
# PRODUCTION ENVIRONMENT
# ========================================
[env.production]
name = "saavy-uptime"
workers_dev = false

[env.production.vars]
ACCESS_TEAM_DOMAIN = "https://saavylab.cloudflareaccess.com"
ACCESS_AUD = "e8604f5d9df109c391b937c4293c06fa76548def743a48fec18da93e0ddddeda"
DISPATCH_TOKEN = "local-dev-token"
DISPATCH_BASE_URL = "https://api.uptime.saavylab.dev/api"
ENABLE_TICKER_ADMIN = 1

[[env.production.durable_objects.bindings]]
name = "TICKER"
class_name = "Ticker"
script_name = "saavy-uptime"

[[env.production.d1_databases]]
binding = "DB"
database_name = "saavy_uptime"
database_id = "8d1a587f-92b7-419c-8eec-b6850e3d7d62"
migrations_dir = "db/migrations"
migrations_table = "d1_migrations"

[[env.production.analytics_engine_datasets]]
binding = "AE"
dataset = "saavy_uptime"

[[env.production.r2_buckets]]
binding = "ARCHIVE_BUCKET"
bucket_name = "saavy-uptime"