name = "saavy-uptime"
main = "apps/backend/build/index.js"
compatibility_date = "2025-11-11"
workers_dev = false
secrets_store_secrets = [
    { binding = "AE_API_TOKEN", store_id = "339bf9a9619041cabd2825136b3ee3db", secret_name = "AE_API_TOKEN" }
]

[vars]
ACCESS_TEAM_DOMAIN = "https://saavylab.cloudflareaccess.com"
ACCESS_AUD = "e8604f5d9df109c391b937c4293c06fa76548def743a48fec18da93e0ddddeda"
DISPATCH_TOKEN = "local-dev-token"
DISPATCH_BASE_URL = "http://127.0.0.1:8787/api"
ENABLE_TICKER_ADMIN = 1
AE_ACCOUNT_ID = "aef405d01b3d36d6b5ebeed5efe8c2f8"
AE_DATASET = "saavy_uptime_dev"

[build]
command = "cargo install worker-build && worker-build --release"

[[durable_objects.bindings]]
name = "TICKER"
class_name = "Ticker"
script_name = "saavy-uptime"

[[migrations]]
tag = "v1"
new_classes = ["Ticker"]

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[[d1_databases]]
binding = "DB"
database_name = "saavy_uptime_dev"
database_id = "00000000-0000-0000-0000-000000000000"
preview_database_id = "038435b0-ef7d-4232-80c3-fe90c57417f0"
migrations_dir = "apps/backend/db/migrations"
migrations_table = "d1_migrations"

[[analytics_engine_datasets]]
binding = "AE"
dataset = "saavy_uptime_dev"

[[r2_buckets]]
binding = "ARCHIVE_BUCKET"
bucket_name = "saavy-uptime-dev"
preview_bucket_name = "saavy-uptime-preview"

[[queues.producers]]
queue = "heartbeat-queue"
binding = "heartbeat-queue"

[[queues.consumers]]
queue = "heartbeat-queue"
max_batch_size = 100
max_batch_timeout = 5

[[queues.producers]]
queue = "trace-queue"
binding = "trace-queue"

[[queues.consumers]]
queue = "trace-queue"
max_batch_size = 100
max_batch_timeout = 5

# ========================================
# PREVIEW ENVIRONMENT
# ========================================
[env.preview]
name = "saavy-uptime-preview"
workers_dev = true
secrets_store_secrets = [
    { binding = "AE_API_TOKEN", store_id = "339bf9a9619041cabd2825136b3ee3db", secret_name = "AE_API_TOKEN" }
]

[env.preview.vars]
ACCESS_TEAM_DOMAIN = "https://saavylab.cloudflareaccess.com"
ACCESS_AUD = "e8604f5d9df109c391b937c4293c06fa76548def743a48fec18da93e0ddddeda"
DISPATCH_TOKEN = "local-dev-token"
DISPATCH_BASE_URL = "https://api.uptime.saavylab.dev/api"
ENABLE_TICKER_ADMIN = 1
AE_ACCOUNT_ID = "aef405d01b3d36d6b5ebeed5efe8c2f8"
AE_DATASET = "saavy_uptime_preview"

[[env.preview.durable_objects.bindings]]
name = "TICKER"
class_name = "Ticker"
script_name = "saavy-uptime-preview"

[[env.preview.migrations]]
tag = "v1"
new_classes = ["Ticker"]

[[env.preview.d1_databases]]
binding = "DB"
database_name = "saavy_uptime_preview"
database_id = "038435b0-ef7d-4232-80c3-fe90c57417f0"
preview_database_id = "038435b0-ef7d-4232-80c3-fe90c57417f0"
migrations_dir = "apps/backend/db/migrations"
migrations_table = "d1_migrations"

[[env.preview.analytics_engine_datasets]]
binding = "AE"
dataset = "saavy_uptime_preview"

[[env.preview.r2_buckets]]
binding = "ARCHIVE_BUCKET"
bucket_name = "saavy-uptime-preview"
preview_bucket_name = "saavy-uptime-preview"

[[env.preview.queues.producers]]
queue = "trace-queue"
binding = "trace-queue"

[[env.preview.queues.consumers]]
queue = "trace-queue"
max_batch_size = 100
max_batch_timeout = 5

[[env.preview.queues.producers]]
queue = "heartbeat-queue"
binding = "heartbeat-queue"

[[env.preview.queues.consumers]]
queue = "heartbeat-queue"
max_batch_size = 100
max_batch_timeout = 5

# ========================================
# PRODUCTION ENVIRONMENT
# ========================================
[env.production]
name = "saavy-uptime"
workers_dev = false
secrets_store_secrets = [
    { binding = "AE_API_TOKEN", store_id = "339bf9a9619041cabd2825136b3ee3db", secret_name = "AE_API_TOKEN" }
]


[env.production.vars]
ACCESS_TEAM_DOMAIN = "https://saavylab.cloudflareaccess.com"
ACCESS_AUD = "e8604f5d9df109c391b937c4293c06fa76548def743a48fec18da93e0ddddeda"
DISPATCH_TOKEN = "local-dev-token"
DISPATCH_BASE_URL = "https://api.uptime.saavylab.dev/api"
ENABLE_TICKER_ADMIN = 1
AE_ACCOUNT_ID = "aef405d01b3d36d6b5ebeed5efe8c2f8"
AE_DATASET = "saavy_uptime"

[[env.production.durable_objects.bindings]]
name = "TICKER"
class_name = "Ticker"
script_name = "saavy-uptime"

[[env.production.d1_databases]]
binding = "DB"
database_name = "saavy_uptime"
database_id = "8d1a587f-92b7-419c-8eec-b6850e3d7d62"
migrations_dir = "apps/backend/db/migrations"
migrations_table = "d1_migrations"

[[env.production.analytics_engine_datasets]]
binding = "AE"
dataset = "saavy_uptime"

[[env.production.r2_buckets]]
binding = "ARCHIVE_BUCKET"
bucket_name = "saavy-uptime"


[[env.production.queues.producers]]
queue = "trace-queue"
binding = "trace-queue"

[[env.production.queues.consumers]]
queue = "trace-queue"
max_batch_size = 100
max_batch_timeout = 5